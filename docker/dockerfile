# Start from the latest golang base image
FROM pandoc/core:latest

# Install Pandoc and LaTeX
RUN apk --no-cache add texlive-xetex

RUN apk add --no-cache -t .deps curl && \
    curl -LO https://dl.google.com/go/go1.21.2.linux-amd64.tar.gz && \
    tar -C /usr/local -xzf go1.21.2.linux-amd64.tar.gz && \
    rm go1.21.2.linux-amd64.tar.gz && \
    apk del .deps

ENV PATH="/usr/local/go/bin:${PATH}"

# Add Maintainer Info
LABEL maintainer="colton.shaw@mattermost.com"
LABEL org.opencontainers.image.title="mm-healthcheck"
LABEL org.opencontainers.image.description="Mattermost Healthcheck Image"
LABEL org.opencontainers.image.authors="Colton Shaw"
LABEL org.opencontainers.image.source="https://github.com/coltoneshaw/mm-healthcheck"
LABEL org.opencontainers.image.licenses=MIT

# Set the Current Working Directory inside the container
WORKDIR /app

# Copy go mod and sum files
COPY ./go.mod ./go.sum ./template.tex ./checks.yaml ./config.yaml ./

# Download all dependencies. Dependencies will be cached if the go.mod and go.sum files are not changed
RUN go mod download

# Copy the source from the current directory to the Working Directory inside the container
COPY ./healthcli/ ./healthcli

# Build the Go app
RUN go build -o healthcheck ./healthcli

# Command to run the executable
ENTRYPOINT ["./healthcheck"]