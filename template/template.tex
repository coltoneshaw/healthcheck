\documentclass{article}
\usepackage{hyperref}
\usepackage{geometry}
\usepackage{tabularray}
\usepackage{xcolor}
\usepackage{fontspec}
\usepackage{soul}
\usepackage{ifthen}
\usepackage{fancyhdr}
\usepackage{roboto}
\usepackage{xstring}

\usepackage{graphicx}

\geometry{top=0.75in, bottom=0.75in, left=0.25in, right=0.25in}
\geometry{landscape}

% The url formatting to have it set for blue
\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    filecolor=magenta,      
    urlcolor=blue,
    pdfborderstyle={/S/U/W 1}
}

\let\oldhref\href
\renewcommand{\href}[2]{\oldhref{#1}{\ul{#2}}}

% This processes the status field and returns the image circle. This is based on the status column of a check
% The images must be included in the ./template folder on the base repo.
\newcommand{\statusimage}[1]{%
    \centering
    \IfStrEqCase{#1}{%
            {pass}{\includegraphics[width=.6cm, height=.6cm]{green-circle}}%
            {warn}{\includegraphics[width=.6cm, height=.6cm]{yellow-circle}}%
            {fail}{\includegraphics[width=.6cm, height=.6cm]{red-circle}}%
            {ignore}{\includegraphics[width=.6cm, height=.6cm]{white-circle}}%
            {error}{\includegraphics[width=.6cm, height=.6cm]{error-image}}%
    }[{#1}]%
}

% Setting this to a Mattermost approved font and making it the default
\setsansfont{Roboto}
\renewcommand*\familydefault{\sfdefault}

% Header for the document
\pagestyle{fancy}
\fancyhf{}
\lhead{$metadata.companyName$}
\rhead{$metadata.date$}


\begin{document}

\section*{Mattermost Healthcheck Report}

This is an auto generated report from the healthcheck tool.

\section{Environment Checks}\label{sec:environment-checks}

\begin{tblr}{|Q[l,m]|Q[l,m]|Q[l,m]|Q[l,m,3cm]|Q[l,m,3cm]|X[l,m]|}
  \hline
  ID & SEV & STATUS & NAME & RESULT & DESCRIPTION \\
  \hline
$for(environment)$

  \MakeUppercase{$environment.id$}  &
  $environment.severity$ & 
  \statusimage{$environment.status$} &
  $environment.name$ & 
  $environment.result$ &
  $environment.description$ \\

  \hline
$endfor$
\end{tblr}

\section{Packet Checks}\label{sec:packet-checks}

\begin{tblr}{|Q[l,m]|Q[l,m]|Q[l,m]|Q[l,m,3cm]|Q[l,m,3cm]|X[l,m]|}
  \hline
  ID & SEV & STATUS & NAME & RESULT & DESCRIPTION \\
  \hline
$for(packet)$

  \MakeUppercase{$packet.id$}  &
  $packet.severity$ &
  \statusimage{$packet.status$} &
  $packet.name$ &
  $packet.result$ &
  $packet.description$ \\

  \hline
$endfor$
\end{tblr}

\section{Configuration Checks}\label{sec:configuration-checks}

\begin{tblr}{|Q[l,m]|Q[l,m]|Q[l,m]|Q[l,m,3cm]|Q[l,m,3cm]|X[l,m]|}
  \hline
  ID & SEV & STATUS & NAME & RESULT & DESCRIPTION \\
  \hline
$for(config)$

  \MakeUppercase{$config.id$}  &
  $config.severity$ & 
  \statusimage{$config.status$} &
  $config.name$ & 
  $config.result$ &
  $config.description$ \\

  \hline
$endfor$
\end{tblr}

\section{Mattermost Log}\label{sec:mattermost-log}

\subsection{Checks}\label{subsec:checks}

\begin{tblr}{|Q[l,m]|Q[l,m]|Q[l,m]|Q[l,m,3cm]|Q[l,m,3cm]|X[l,m]|}
  \hline
  ID & SEV & STATUS & NAME & RESULT & DESCRIPTION \\
  \hline
$for(mattermostLog)$

  \MakeUppercase{$mattermostLog.id$} &
  $mattermostLog.severity$ &
  \statusimage{$mattermostLog.status$} &
  $mattermostLog.name$ &
  $mattermostLog.result$ &
  $mattermostLog.description$ \\

  \hline
$endfor$
\end{tblr}

\subsection{Top Logs}\label{subsec:top-logs}

\begin{tblr}{|Q[l,m]|Q[l,m]|X[m]|Q[l,m]|}
  \hline
  COUNT & LEVEL & MESSAGE & CALLER \\
  \hline
$for(topLogs)$
  $topLogs.count$ & $topLogs.level$ & $topLogs.msg$ & $topLogs.caller$  \\
  \hline
$endfor$
\end{tblr}

\newcommand{\pluginlink}[2]{%
  \ifthenelse{\equal{#1}{}}%
    {#2}%  % code to execute if the condition is true
    {\href{#1}{#2}}  % code to execute if the condition is false
}


\section{Plugins}\label{sec:plugins}

\subsection{Active}\label{subsec:active}

\begin{tblr}{|Q[l,m]|Q[l,m]|Q[l,m]|Q[l,m]|Q[l,m]|}
      \hline
      ID & NAME & INSTALLED VERSION & LATEST VERSION & SUPPORT \\
      \hline
      $for(plugins)$
        $if(plugins.active)$
          $plugins.pluginID$ &

          \pluginlink{$plugins.pluginURL$}{$plugins.pluginName$} &

          $if(plugins.isUpdated)$
            $plugins.installedVersion$
          $else$
            $if(plugins.latestVersion)$
              \textcolor{red}{$plugins.installedVersion$}
            $else$
              $plugins.installedVersion$
            $endif$
          $endif$ &

          $plugins.installedVersion$
          $if(plugins.latestReleaseDate)$
            \footnotesize($plugins.latestReleaseDate$)
          $endif$ &

          $plugins.supportLevel$ \\
          \hline
        $endif$
      $endfor$
    \end{tblr}

  \subsection{Inactive}\label{subsec:inactive}

\begin{tblr}{|Q[l,m]|Q[l,m]|Q[l,m]|Q[l,m]|Q[l,m]|}
      \hline
      ID & NAME & INSTALLED VERSION & LATEST VERSION & SUPPORT \\
      \hline
      $for(plugins)$
      $if(plugins.active)$
      $else$
          $plugins.pluginID$ &

          \pluginlink{$plugins.pluginURL$}{$plugins.pluginName$} &

            % showing black text if the plugin is updated, and red if  it's not.
          $if(plugins.isUpdated)$
            $plugins.installedVersion$
          $else$
            % only showing the red if a latest version exists
            $if(plugins.latestVersion)$
              \textcolor{red}{$plugins.installedVersion$}
            $else$
              $plugins.installedVersion$
            $endif$
          $endif$ &

          $plugins.latestVersion$
          $if(plugins.latestReleaseDate)$
            \footnotesize($plugins.latestReleaseDate$)
          $endif$ &

          $plugins.supportLevel$ \\
          \hline
        $endif$
      $endfor$
    \end{tblr}

\end{document}